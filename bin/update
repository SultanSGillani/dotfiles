#!/usr/bin/env bash

set -o errexit
set -o pipefail
set -o nounset

ZSH=${HOME}/dotfiles

PLAYBOOK=${HOME}/dotfiles/dotfiles.yml

HOSTS=${HOME}/dotfiles/inventory.yml

# Run main playbook

HOST_OS=$(uname)

cd ${ZSH} && git pull

if [[ $# -eq 0 ]]; then
  echo "Running dotfiles update for ${HOST_OS}"
  if [[ "${HOST_OS}" = 'Darwin' ]] || [[ "${HOST_OS}" = 'Linux' ]]; then
  ansible-playbook -i ${HOSTS} ${PLAYBOOK} --vault-password-file ~/.vault_password.txt --skip-tags initial
  else
    echo "Unknown host OS: ${HOST_OS}"
    exit 1
  fi
else
    echo "Running dotfiles update for ${HOST_OS}"
  if [[ "${HOST_OS}" = 'Darwin' ]] || [[ "${HOST_OS}" = 'Linux' ]]; then
  ansible-playbook -i ${HOSTS} ${PLAYBOOK} --vault-password-file ~/.vault_password.txt --skip-tags initial --tags "$@"
  else
    echo "Unknown host OS: ${HOST_OS}"
    exit 1
  fi
fi

trap - EXIT
